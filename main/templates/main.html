{% extends 'base.html' %}
{% load static %}

{% block meta %}
<name>Femininomenon Sports</name>
{% endblock meta %}

{% block content %}
{% include 'navbar.html' %}

<div class="bg-pink-50 w-full pt-16 min-h-screen">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <!-- Header Section -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900 mb-2">Your No. 1 source for sport stuff</h1>
      <p class="text-gray-600">Explore our products and find whatever you need!</p>
    </div>

    <!-- TOOLBAR -->
    <div class="w-11/12 max-w-6xl flex flex-col sm:flex-row justify-between items-center mt-6 space-y-3 sm:space-y-0">
      <div class="flex items-center space-x-2">
        <label for="categoryFilter" class="text-gray-700 font-semibold">Category:</label>
        <select id="categoryFilter" class="text-gray-700 border rounded px-3 py-1">
          <option value="all">All</option>
          <option value="featured">Featured</option>
        </select>
      </div>

      <div class="flex items-center space-x-2">
        <label for="sortFilter" class="text-gray-700 font-semibold">Sort:</label>
        <select id="sortFilter" class="border rounded px-3 py-1">
          <option value="default">Default</option>
          <option value="lowprice">Lowest Price</option>
          <option value="highprice">Highest Price</option>
        </select>

        <button id="refreshBtn" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">
          Refresh
        </button>

        <button onclick="showModal()" class="bg-pink-600 text-white px-4 py-1 rounded hover:bg-pink-700">
          + Add Product
        </button>
      </div>
    </div>

    <!-- PRODUCT GRID -->
    <div class="w-11/12 max-w-6xl mt-10">
      <div id="loadingState" class="text-center text-gray-500 my-6 hidden">Loading products...</div>
      <div id="errorState" class="text-center text-red-600 my-6 hidden">Error loading products. Try again.</div>
      <div id="emptyState" class="text-center text-gray-500 my-6 hidden">No products found.</div>
      <div id="productContainer" class="grid sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
    </div>
{% endblock content %}
{% block script %}
<script>
const PRODUCT_API = "{% url 'main:show_json' %}";
const CATEGORY_API = "{% url 'main:get_categories_ajax' %}";
let allProducts = [];

// === FETCH PRODUCTS ===
async function fetchProducts() {
  showLoading(true);
  hideError();
  try {
    const res = await fetch(PRODUCT_API);
    if (!res.ok) throw new Error("Failed to fetch products");
    allProducts = await res.json();
    renderProducts(allProducts);
  } catch (err) {
    console.error(err);
    showError();
    showToast("Error loading products", "", "error");
  } finally {
    showLoading(false);
  }
}

// === RENDER PRODUCTS ===
function renderProducts(products) {
  const container = document.getElementById("productContainer");
  const empty = document.getElementById("emptyState");
  container.innerHTML = "";

  if (!products.length) {
    empty.classList.remove("hidden");
    return;
  } else empty.classList.add("hidden");

  products.forEach(p => {
    const card = document.createElement("div");
    card.className = "bg-white rounded-lg shadow p-4 flex flex-col transition-transform hover:scale-[1.02]";
    card.onclick = () => window.location.href = `/product/${p.id}/`;
    card.innerHTML = `
      <img src="${p.thumbnail || 'https://via.placeholder.com/200'}" class="rounded mb-4 w-full h-40 object-cover">
      <h3 class="font-bold text-lg">${p.name}</h3>
      <p class="text-gray-600 mb-4">Rp ${p.price}</p>
      <p class="text-sm text-gray-500 mb-4">${p.description}</p>
      <div class="flex justify-between mt-auto pointer-events-auto">
        <button onclick="event.stopPropagation(); openEditModal('${p.id}', '${p.name}', '${p.price}', '${p.description}', '${p.category}', '${p.thumbnail}')" class="text-blue-600 px-3 py-1 rounded hover:text-white hover:bg-blue-600">Edit</button>
        <button onclick="event.stopPropagation(); openDeleteModal('${p.id}')" class="text-red-600 px-3 py-1 rounded hover:text-white hover:bg-red-600">Delete</button>
      </div>
    `;
    container.appendChild(card);
  });
}

// === CATEGORY FILTER ===
async function loadCategories() {
  try {
    const res = await fetch(CATEGORY_API);
    if (!res.ok) throw new Error("Failed to fetch categories");
    const categories = await res.json();
    const categoryFilter = document.getElementById("categoryFilter");
    categoryFilter.innerHTML = `
      <option value="all">All</option>
      <option value="featured">Featured</option>
    `;

    if (categories && categories.length) {
      categories.forEach(cat => {
        const opt = document.createElement("option");
        opt.value = cat;
        opt.textContent = cat.charAt(0).toUpperCase() + cat.slice(1);
        categoryFilter.appendChild(opt);
      });
    } 
    fillModalCategories(categories);
    } catch (err) {
      console.error("Error loading categories:", err);
      showToast("Failed to load categories", "", "error");
    }
  }

  function fillModalCategories(categories) {
    const catSelect = document.getElementById("category");
    if (!catSelect) return;
    catSelect.innerHTML = `<option value="">Choose a category</option>`;
    categories.forEach(cat => {
      const opt = document.createElement("option");
      opt.value = cat;
      opt.textContent = cat.charAt(0).toUpperCase() + cat.slice(1);
      catSelect.appendChild(opt);
    });
  }

  // === DYNAMIC CATEGORY HANDLING ===
// Show input if user selects "Add new category"
document.getElementById("productCategory").addEventListener("change", (e) => {
  const newCategoryInput = document.getElementById("newCategoryInput");
  if (e.target.value === "__new__") {
    newCategoryInput.classList.remove("hidden");
    newCategoryInput.required = true;
  } else {
    newCategoryInput.classList.add("hidden");
    newCategoryInput.required = false;
    input.value = "";
  }
});

// === FILTER & SORT ===
document.getElementById("categoryFilter").addEventListener("change", applyFilters);
document.getElementById("sortFilter").addEventListener("change", applyFilters);

function applyFilters() {
  const cat = document.getElementById("categoryFilter").value;
  const sort = document.getElementById("sortFilter").value;
  let filtered = [...allProducts];

  if (cat === "featured") filtered = filtered.filter(p => p.is_featured === "True");
  else if (cat !== "all") filtered = filtered.filter(p => p.category === cat);

  if (sort === "lowprice") filtered.sort((a, b) => parseFloat(a.price) - parseFloat(b.price));
  if (sort === "highprice") filtered.sort((a, b) => parseFloat(b.price) - parseFloat(a.price));

  renderProducts(filtered);
}

// === STATE HANDLERS ===
function showLoading(show) {
  document.getElementById("loadingState").classList.toggle("hidden", !show);
}
function showError() {
  document.getElementById("errorState").classList.remove("hidden");
}
function hideError() {
  document.getElementById("errorState").classList.add("hidden");
}

// === REFRESH BUTTON ===
document.getElementById("refreshBtn").addEventListener("click", () => {
  showToast("Refreshing...", "", "normal");
  fetchProducts();
  loadCategories();
});

// === MODAL EVENTS ===
document.addEventListener("productAdded", () => {
  fetchProducts();
  loadCategories();
});

// === INIT ===
loadCategories();
fetchProducts();
</script>
{% endblock script %}
