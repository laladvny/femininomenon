<!-- ADD PRODUCT MODAL -->
<div id="crudModal" class="hidden fixed inset-0 z-50 w-full flex items-center justify-center bg-gray-800 bg-opacity-50">
  <div id="crudModalContent" class="bg-white rounded-lg shadow-lg w-5/6 sm:w-3/5 md:w-1/2 lg:w-2/5 xl:w-1/3 max-h-screen overflow-y-auto transition-all transform opacity-0 scale-95">
    <div class="flex items-center justify-between p-4 border-b">
      <div>
        <h3 class="text-xl font-semibold text-gray-900">Add New Product</h3>
        <p class="text-sm text-gray-600 mt-1">Share your own product!</p>
      </div>
      <button type="button" class="text-gray-400 hover:bg-gray-200 hover:text-gray-900 rounded-lg p-1.5" onclick="hideModal()">
        <svg aria-hidden="true" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
        </svg>
      </button>
    </div>

    <div class="px-6 py-4 space-y-6">
      <form id="productForm">
        {% csrf_token %}
        <div class="mb-4">
          <label for="name" class="block text-sm font-medium text-gray-700">Name</label>
          <input type="text" id="name" name="name" class="w-full border rounded-md px-3 py-2" placeholder="Enter product name" required>
        </div>
        <div class="mb-4">
          <label for="price" class="block text-sm font-medium text-gray-700">Price</label>
          <input type="number" id="price" name="price" class="w-full border rounded-md px-3 py-2" required>
        </div>
        <div class="mb-4">
          <label for="description" class="block text-sm font-medium text-gray-700">Description</label>
          <textarea id="description" name="description" rows="3" class="w-full border rounded-md px-3 py-2" required></textarea>
        </div>
        <div class="mb-4">
          <label class="block text-gray-700 font-medium mb-1">Category</label>
          <select id="productCategory" name="category" class="w-full border rounded p-2" required>
            <option value="" disabled selected>Select a category</option>
            <option value="__new__">+ Add new category</option>
          </select>
          <input type="text" id="newCategoryInput" class="w-full border rounded p-2 mt-2 hidden" placeholder="Enter new category">
        </div>
        <div class="mb-4">
          <label for="thumbnail" class="block text-sm font-medium text-gray-700">Thumbnail URL</label>
          <input type="url" id="thumbnail" name="thumbnail" class="w-full border rounded-md px-3 py-2" placeholder="https://example.com/image.jpg">
        </div>
        <div class="mb-4 flex items-center">
          <input id="is_featured" name="is_featured" type="checkbox" class="w-4 h-4 text-pink-600 border-gray-300 rounded">
          <label for="is_featured" class="ml-2 text-sm text-gray-900">Featured Product</label>
        </div>
      </form>
    </div>

    <div class="flex flex-col sm:flex-row gap-4 p-6 border-t border-gray-200">
      <button type="button" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50" onclick="hideModal()">Cancel</button>
      <button type="submit" id="submitProduct" form="productForm" class="flex-1 bg-pink-600 text-white px-6 py-3 rounded-md hover:bg-pink-700">Add Product</button>
    </div>
  </div>
</div>

<!--  EDIT PRODUCT MODAL  -->
<div id="editModal" class="hidden fixed inset-0 z-50 w-full flex items-center justify-center bg-gray-800 bg-opacity-50">
  <div id="editModalContent" class="bg-white rounded-lg shadow-lg w-5/6 sm:w-3/5 md:w-1/2 lg:w-2/5 xl:w-1/3 max-h-screen overflow-y-auto transition-all transform opacity-0 scale-95">
    <div class="flex items-center justify-between p-4 border-b">
      <h3 class="text-xl font-semibold text-gray-900">Edit Product</h3>
      <button type="button" class="text-gray-400 hover:bg-gray-200 hover:text-gray-900 rounded-lg p-1.5" onclick="hideEditModal()">
        <svg aria-hidden="true" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
        </svg>
      </button>
    </div>

    <div class="px-6 py-4 space-y-6">
      <form id="editProductForm">
        {% csrf_token %}
        <input type="hidden" id="editId" name="id">
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700">Name</label>
          <input type="text" id="editName" name="name" class="w-full border rounded-md px-3 py-2" required>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700">Price</label>
          <input type="number" id="editPrice" name="price" class="w-full border rounded-md px-3 py-2" required>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700">Description</label>
          <textarea id="editDescription" name="description" rows="3" class="w-full border rounded-md px-3 py-2" required></textarea>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700">Category</label>
          <input type="text" id="editCategory" name="category" class="w-full border rounded-md px-3 py-2">
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700">Thumbnail URL</label>
          <input type="url" id="editThumbnail" name="thumbnail" class="w-full border rounded-md px-3 py-2">
        </div>
      </form>
    </div>

    <div class="flex flex-col sm:flex-row gap-4 p-6 border-t border-gray-200">
      <button type="button" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50" onclick="hideEditModal()">Cancel</button>
      <button type="submit" id="submitEdit" form="editProductForm" class="flex-1 bg-pink-600 text-white px-6 py-3 rounded-md hover:bg-pink-700">Save Changes</button>
    </div>
  </div>
</div>

<!--  DELETE CONFIRMATION MODAL  -->
<div id="deleteModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-gray-800 bg-opacity-50">
  <div id="deleteModalContent" class="bg-white rounded-lg shadow-lg w-80 transition-all transform opacity-0 scale-95 p-6 text-center">
    <h2 class="text-lg font-semibold mb-2">Confirm Deletion</h2>
    <p class="text-gray-600 mb-6">Are you sure you want to delete this product?</p>
    <div class="flex justify-center gap-4">
      <button type="button" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300" onclick="hideDeleteModal()">Cancel</button>
      <button id="confirmDeleteBtn" type="button" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Delete</button>
    </div>
  </div>
</div>


<script>
  function animateModal(modal, content, show) {
    if (show) {
      modal.classList.remove('hidden');
      setTimeout(() => {
        content.classList.remove('opacity-0', 'scale-95');
        content.classList.add('opacity-100', 'scale-100');
      }, 50);
    } else {
      content.classList.remove('opacity-100', 'scale-100');
      content.classList.add('opacity-0', 'scale-95');
      setTimeout(() => modal.classList.add('hidden'), 150);
    }
  }


  function showModal() {
    loadCategoriesForAddProduct();
    animateModal(document.getElementById('crudModal'), document.getElementById('crudModalContent'), true);
  }
  function hideModal() {
    animateModal(document.getElementById('crudModal'), document.getElementById('crudModalContent'), false);
  }


  function openEditModal(id, name, price, description, category, thumbnail) {
    document.getElementById('editId').value = id;
    document.getElementById('editName').value = name;
    document.getElementById('editPrice').value = price;
    document.getElementById('editDescription').value = description;
    document.getElementById('editCategory').value = category;
    document.getElementById('editThumbnail').value = thumbnail;
    animateModal(document.getElementById('editModal'), document.getElementById('editModalContent'), true);
  }
  function hideEditModal() {
    animateModal(document.getElementById('editModal'), document.getElementById('editModalContent'), false);
  }


  var deleteProductId = null;
  function openDeleteModal(id) {
    deleteProductId = id;
    animateModal(document.getElementById("deleteModal"), document.getElementById("deleteModalContent"), true);
  }

  function hideDeleteModal() {
    animateModal(document.getElementById("deleteModal"), document.getElementById("deleteModalContent"), false);
  }

  document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
    if (!deleteProductId) return;
    try {
      const res = await fetch(`/delete-product-ajax/${deleteProductId}/`, {
        method: "DELETE",
        headers: { "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value, "X-Requested-With": "XMLHttpRequest" }
      });

      if (!res.ok) throw new Error("Failed to delete product");

      showToast("Product deleted successfully!", "", "success");
      hideDeleteModal();
      document.dispatchEvent(new Event("productAdded")); // refresh
    } catch (err) {
      console.error(err);
      showToast("Failed to delete product", "", "error");
    }
  });

  async function loadCategoriesForAddProduct() {
    const categorySelect = document.getElementById("productCategory");
    if (!categorySelect) return;

    try {
      const res = await fetch("{% url 'main:get_categories_ajax' %}");
      if (!res.ok) throw new Error("Failed to fetch categories");
      const categories = await res.json();

      // Clear old options
      categorySelect.innerHTML = '<option value="" disabled selected>Select a category</option>';

      // Add categories dynamically
      if (categories.length > 0) {
        categories.forEach(cat => {
          const opt = document.createElement("option");
          opt.value = cat;
          opt.textContent = cat.charAt(0).toUpperCase() + cat.slice(1);
          categorySelect.appendChild(opt);
        });
      }

      // Always append “Add new category”
      const newOption = document.createElement("option");
      newOption.value = "__new__";
      newOption.textContent = "+ Add new category";
      categorySelect.appendChild(newOption);

    } catch (err) {
      console.error("Error loading categories:", err);
      showToast("Failed to load categories", "", "error");
    }
  }

  async function addProduct() {
    const form = document.querySelector('#productForm');
    const categorySelect = document.getElementById("productCategory");
    const selectedCategory = categorySelect.value;
    const newCategoryInput = document.getElementById("newCategoryInput").value.trim();

    // Decide which category to use
    const finalCategory = selectedCategory === "__new__" && newCategoryInput
      ? newCategoryInput
      : selectedCategory;

    // Build FormData manually
    const formData = new FormData(form);
    formData.set("category", finalCategory); // override or set the category

    try {
      const res = await fetch("{% url 'main:add_product_ajax' %}", {
        method: "POST",
        headers: { "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value, "X-Requested-With": "XMLHttpRequest" },
        body: formData,
      });

      if (!res.ok) throw new Error("Failed to add product");

      form.reset();
      document.getElementById("newCategoryInput").classList.add("hidden"); // hide input after use
      hideModal();
      showToast('Product added successfully!', '', 'success');
      document.dispatchEvent(new CustomEvent('productAdded'));
    } catch (err) {
      console.error("Add product failed:", err);
      showToast('Failed to add product', '', 'error');
    }
  }

  // Handle submit
  document.getElementById("productForm").addEventListener("submit", (e) => {
    e.preventDefault();
    addProduct();
  });



  async function saveEditProduct() {
    const id = document.getElementById("editId").value;
    const formData = new FormData(document.querySelector("#editProductForm"));
    const res = await fetch(`/edit-product-ajax/${id}/`, {
      method: "POST",
      headers: { "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value, "X-Requested-With": "XMLHttpRequest" },
      body: formData
    });
    const data = await res.json();
    hideEditModal();
    if (data.success) {
      showToast('Product updated successfully!', '', 'success');
      document.dispatchEvent(new CustomEvent('productAdded'));
    } else {
      showToast('Failed to update product.', '', 'error');
    }
  }
  document.getElementById("editProductForm").addEventListener("submit", e => {
    e.preventDefault();
    saveEditProduct();
  });
</script>